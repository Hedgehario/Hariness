# 残件一覧（Backlog）- MVP v0.1.0

**作成日**: 2026-01-07  
**ステータス**: 📋 保留（リリース後に対応検討）

---

## 概要

MVPリリースに必要な機能は全て実装・検証完了しています。  
本ドキュメントは、自動化が困難な検証項目や将来対応を検討する項目を整理したものです。

---

## 1. 手動検証継続項目（本番環境で確認推奨）

以下のテストケースは自動化が困難なため、本番環境での受入テスト時に手動確認を推奨します。

| テストID      | 項目                     | 理由                         | 優先度 |
| ------------- | ------------------------ | ---------------------------- | ------ |
| TC-AUTH-01    | 重複登録防止             | Supabase Authの挙動に依存    | P1     |
| TC-AUTH-03    | 退会・物理削除確認       | DB操作の確認が必要           | P1     |
| TC-AUTH-04/05 | RLS（認可）確認          | 複数ユーザーセッションが必要 | P0     |
| TC-HH-02      | 連鎖削除確認             | DB制約の確認が必要           | P0     |
| TC-VR-02〜06  | トランザクション等       | 複雑なDB操作                 | P1     |
| TC-SYS-02     | ネットワーク遮断時の挙動 | ブラウザ操作が複雑           | P1     |
| TC-SYS-03     | リマインダー自動遷移     | 日時操作が必要               | P1     |

### 検証方法メモ

- **TC-AUTH-04/05 (RLS)**: 2つのブラウザで異なるユーザーでログインし、他ユーザーのデータにアクセス不可を確認
- **TC-HH-02 (連鎖削除)**: 個体削除後、Supabase Studioで関連レコードが削除されていることを確認
- **TC-SYS-02 (ネットワーク遮断)**: DevToolsでオフラインにし、保存操作時のエラー表示とデータ保持を確認

---

## 2. 開発残件チェックリスト

| 項目                           | 状態      | 対応時期                                                                 |
| ------------------------------ | --------- | ------------------------------------------------------------------------ |
| お問い合わせメールアドレス設定 | 🟡 未設定 | **リリース時に必須**（`src/app/(main)/home/page.tsx` の `MAIL_ADDRESS`） |
| カバレッジツール導入           | ⏳ 後回し | リリース後                                                               |
| パフォーマンス測定ツール       | ⏳ 後回し | ユーザー増加時                                                           |
| アクセスログ解析ツール         | ⏳ 後回し | リリース後                                                               |
| アラート機能の仕様策定と実装   | ⏳ 後回し | V1.x以降（現在は簡易版のみ実装済）                                       |
| プッシュ通知機能               | ⏳ 後回し | V1.x以降                                                                 |

---

## 3. 将来の機能拡張・改善案リスト（Future Roadmap）

本プロジェクト（MVP）の開発中に出たアイデアや、リリース後（V2以降）に検討すべき機能改善案です。

### 3.1 データベース・機能設計

#### リマインダーの個体紐付け (Optional)

- **現状 (MVP)**: リマインダーはユーザー（飼い主）に紐付くのみ。「Aちゃんの薬」などはタイトルで管理。
- **改善案**: `CARE_REMINDERS` テーブルに `hedgehog_id` カラムを追加し、UIで対象個体を選択可能にする。

#### 単発の記録アクション (API)

- **現状 (MVP)**: `saveDailyBatch` で一括保存のみ。
- **改善案**: ウィジェットやショートカット用に、単発APIエンドポイント (`saveWeightRecord` 等) を復活させる。

#### カレンダーイベントの対象指定

- **現状 (MVP)**: カレンダーイベントは個体紐付けなし。
- **改善案**: イベント作成時に「対象の個体」または「全員」を選択可能にする。

#### 気温・湿度グラフ (V2+)

- **現状 (MVP)**: 体重グラフのみ表示。気温・湿度は記録のみ。
- **改善案**: 気温・湿度の推移グラフを追加し、環境変化と健康状態の相関を可視化する。

### 3.2 管理者機能 (P1)

#### データ活用・ダッシュボード

- **現状 (MVP)**: 管理機能なし（DB直接操作）。
- **改善案**:
  - **管理者アイコン**: ヘッダーにレンチアイコンを表示（管理者のみ）。
  - **KPIダッシュボード**: 登録数、アクティブ率の可視化。
  - **データエクスポート**: ユーザー属性、バイタル記録、退会ログなどをCSV出力（`10_管理者用機能データエクスポート仕様書.md` 準拠）。

#### お知らせ管理

- **現状 (MVP)**: 機能なし。
- **改善案**: 管理画面からのお知らせ投稿・編集・削除機能。

### 3.3 UI/UX改善

#### カレンダーからの記録操作

- **改善案**: 日付長押し等で、直接「体重」や「食事」を記録できるモーダルを呼び出す。

#### カレンダーの「今後30日の予定」表示

- **現状 (MVP)**: カレンダーのみ表示。
- **改善案**: カレンダー下部や別タブに、直近の予定をリスト形式で表示する。

#### ~~スプラッシュスクリーン~~ ✅ 実装完了

- ~~**改善案**: ブランドロゴ + アプリ名を表示するカスタムスプラッシュスクリーンを作成。~~
- **実装日**: 2026-01-16

#### ~~OGP画像・ファビコン整備~~ ✅ 実装完了

- ~~**改善案**: SNSシェア用OGP画像、各サイズファビコン、Twitter Card対応。~~
- **実装日**: 2026-01-16
- **対応内容**: layout.tsxにopenGraphとTwitter Cardメタデータを追加

#### ローディングスケルトンの改善

- **改善案**: コンテンツ形状に合わせたスケルトンUI（カード型、リスト型）の作成。

#### オフライン対応（PWA強化）

- **改善案**: Service Workerによるキャッシュ、オフラインバナー、同期キューの実装。

#### 操作性の改善 (Usability)

- ~~**PWAインストール**: "Add to Homescreen"押下後、アイコン表示まで約3秒のラグがある。改善検討。~~
  - ✅ **解決済み (2026-01-16)**: アイコンが各5.43MBと巨大だったため圧縮。合計22MB→636KBに97%削減。
- **スワイプ操作**: スマホのスワイプ（スライド）操作でタブ切り替えができるようにしたい。
- **タップ反応**: タップしても反応しない（反応が悪い）ケースの調査と改善。

### 3.3 分析・インサイト機能

#### グラフ機能の強化

- **改善案**: 「食事量と体重の相関」グラフ、同年代平均との比較など。

#### アラート機能の具体化

1. **🚨 緊急アラート**: 温度・湿度異常時の即時通知。
2. **📉 変化・予兆アラート**: 体重減少トレンド、食欲不振（3日連続完食なし）の検知。
3. **💩 健康状態アラート**: 異常便の連続記録時に病院受診を提案。
4. **🗓️ リテンション**: 未記録アラート（安否確認）。

#### 通知設定・プッシュ通知 (P1)

- **現状 (MVP)**: 画面内表示のみ。
- **改善案**:
  - **プッシュ通知実装**: Service Workerを用いたWeb Push通知。
  - **通知設定**: お世話、アラート、お知らせごとのON/OFF詳細設定。

### 3.4 ビジネス・データ戦略 (Future Strategy)

#### データ活用とマネタイズ

- **概要**: 利用者の属性が明確な特化型サービスであるため、データ活用によるマネタイズの可能性が高い。
- **戦略**:
  - 利用者のデータをいかに集めるかを考えたData戦略を策定する。
  - データを求めている事業者（例：ペットフードメーカー、製薬会社、研究機関）と連携する。
- **参考モデル (Ubie事例)**:
  - 個人の症状情報と通院情報をマーケティング情報として製薬会社（MA）に提供するモデル。
  - Harinessの場合：「ハリネズミの健康状態・症状」×「通院・診療所データ」の蓄積に価値がある。

---

## 関連ドキュメント

| ドキュメント                     | 内容               |
| -------------------------------- | ------------------ |
| `automated_test_report.md`       | 自動テスト実施結果 |
| `development_rules_checklist.md` | 開発ルール対応状況 |
| `15_テスト設計書.md`             | テストケース定義   |

---

## メンターフィードバック（2026-01-12 面談メモ）

### 1. ページ遷移・パフォーマンス改善

#### 🔍 指摘された課題

**ボトムナビゲーション（4つのタブ）の挙動について**

現在、画面遷移のパターンは以下の2種類に分かれるはず：

1. **ブラウザバック（戻る操作）**: 履歴を遡るだけなので、データの再取得は不要
2. **ページ遷移（新規ナビゲーション）**: 必要に応じてデータを取得

**問題点**: 現状、ブラウザバックでも毎回APIを叩いてリロードしてしまっている。これは本来不要な処理。

#### 💡 改善の考え方

**「ダーティフラグ」パターン**

- データが**変更された（dirty）**ときのみAPIを呼び、そうでなければキャッシュを使う
- 単なるキャッシュシステムとは異なり、「データが書き換わったかどうか」を基準にする

**現状と改善後の違い**

- **現状**: ページ遷移するたびに毎回APIを叩いている → 動作が重い
- **改善後**: データが変更されたときのみAPIを叩く → サクサク動く

#### 🛠 調査・実装のヒント

1. **Reactのメモ化（Memoization）** を調査する
   - `useMemo`, `useCallback`, `React.memo` など
   - Next.js App Routerでは `fetch` のキャッシュ機能もある
   - 「Reactのメモ化」で検索し、現在のコードに適用できる箇所を探す
2. **Next.js のキャッシュ戦略**
   - Server Componentsのデフォルトキャッシュ挙動を確認
   - `revalidatePath` の呼び出しタイミングを見直す（編集時のみに限定）

3. **対象画面ごとの検討**
   - 記録系・カレンダー: どこまで読み込むか（範囲）を検討
   - 設定画面: 「戻る」ボタンはブラウザバックで問題ない

---

#### ✅ 2026/01/16 パフォーマンス改善対応

**1. 「戻る」ボタンの改善 (完了)**

- 各画面の「戻る」ボタン（および設定画面のナビゲーション）を、`Link`コンポーネントによる新規ページ遷移から `router.back()` によるブラウザバックに変更しました。
- これにより、戻る操作時はサーバーへのリクエスト（ローディング）が発生せず、即座に前の画面が表示されるようになりました。

**2. データの取得とキャッシュ (一部完了)**

- `hedgehogs/actions.ts` の `revalidatePath` を `revalidateTag` に変更し、無駄なキャッシュ無効化を防ぐようにしました。
- `unstable_cache` は Supabase (`cookies()`) との互換性問題があるため、現時点では導入を見送りました。

**⚠️ 残課題: フッタータブ切り替え時のリロード**

- フッタータブ（ホーム、記録、カレンダー）を切り替える際は、依然として新規ページ遷移（サーバーリクエスト）が発生します。
- これを「サクサク」にするには、**TanStack Query** 等のクライアントサイドキャッシュライブラリを導入し、一度取得したデータをクライアント側で保持する必要があります。
- これは大規模な改修となるため、機能実装が落ち着いたタイミングでの実施を推奨します。

---

### 2. マップ機能の改善

#### 🔍 指摘された課題

- マップのデフォルト表示位置が設定されていない
- ユーザーの位置情報を活用していない

#### 💡 改善案

1. **デフォルト表示位置の設定**
   - ユーザー分布が関東・関西に多いなら、東京中心をデフォルトにする
   - 例: 東京駅周辺（緯度: 35.6812, 経度: 139.7671）

2. **位置情報取得の実装**
   - Geolocation APIを使い、ユーザーの現在地を取得
   - 「近くの病院を探す」機能の追加

3. **ユースケースを考慮したUX改善**
   - 病院を探す → 通院記録への導線を設ける
   - 例: マップで病院を選択 → 「この病院で通院記録を作成」ボタン

---

### 3. セキュリティ観点での確認事項

#### 🔍 心配しておくべき点

1. **決済関連**（現状は該当なし、将来的に課金機能を追加する場合）
   - データ改ざん対策
   - 個人情報の保護

2. **認証・パスワード管理**
   - ID/パスワードを忘れた場合のリセットフロー（⚠️ **未実装**）
   - リセットメールのセキュリティ（トークン有効期限など）

3. **本人確認（KYC）の考え方**
   - トラブル発生時（不正アクセス、アカウント乗っ取りなど）を想定
   - 本人確認に必要なデータを事前に整理しておく
   - 例: 登録メールアドレス、登録日時、最終ログイン日時、使用デバイス情報など
   - 「どうやって本人であることを確認するか」の手順を決めておく

#### ✅ 現状の対応状況

- パスワードリセット: ⏸️ **実装済みだがSMTP設定待ち**（`/forgot-password`、`/reset-password`画面は作成済み。Supabase組み込みメールのレート制限により動作不可。Resend等のカスタムSMTP設定が必要）
- RLS（行レベルセキュリティ）: ✅ 実装済み
- 退会ログ: ✅ 匿名化して保存（WITHDRAWAL_LOGSテーブル）

---

### 📋 アクションアイテム（優先度順）

| 優先度 | カテゴリ       | 対応内容                                                                            |
| :----: | -------------- | ----------------------------------------------------------------------------------- |
|   高   | パフォーマンス | ブラウザバック時の不要なAPI呼び出しを削減                                           |
|   高   | パフォーマンス | `revalidatePath` の呼び出しを編集時のみに限定                                       |
|   高   | インフラ       | **カスタムSMTP設定（Resend推奨）** - 新規登録・パスワードリセットのメール送信に必要 |
|   中   | UX             | マップのデフォルト表示位置を東京中心に設定                                          |
|   中   | UX             | 位置情報取得機能の追加検討                                                          |
|   低   | セキュリティ   | 本人確認手順のドキュメント化                                                        |
