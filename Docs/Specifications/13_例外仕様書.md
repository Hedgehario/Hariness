**プロジェクト名**: Hariness（ハリネス）  
**作成日**: 2025年12月18日  
**作成者**: 城田 航

---

## 1. 概要

本ドキュメントは、Hariness において発生する可能性のある異常系（例外・エラー）について、その種類・発生条件・システム挙動・ユーザーへのフィードバック方針を定義します。

本仕様は、Server Actions がエラーを返す際の形式と対応し、フロントエンドとバックエンドの両方で一貫したエラーハンドリングを実現するための基盤となります。

## 2. 目的

本ドキュメントの目的は以下の通りです：

1. **エラーコード体系の標準化**: アプリケーション全体で使用するエラーコードを統一し、開発・運用・保守の効率を向上させます。
2. **一貫したエラーハンドリング**: 同じエラーコードに対して、システム全体で一貫した挙動とユーザーへのフィードバックを実現します。
3. **開発効率の向上**: エラーの種類と対応方法を事前に定義することで、実装時の判断を迅速化し、コードレビューの質を向上させます。
4. **運用・保守性の向上**: エラーログの分析や障害対応を効率化し、システムの信頼性を高めます。

---

## 3. エラーレスポンス形式

本ドキュメントで定義する例外は、Server Actions の `ActionResponse` 型に従って返却されます。

### 3.1 基本構造

```typescript
{
  success: false,
  error: {
    code: "VALIDATION_ERROR",  // ← この code の値が、本仕様書の「エラーコード (API)」と一致
    meta?: { /* 動的メッセージ用の補足情報 */ }
  }
}
```

### 3.2 エラーコードの対応

本仕様書で定義した「エラーコード (API)」（例：`VALIDATION_ERROR`, `AUTH_FAILED` など）は、上記の `error.code` として返却されます。

### 3.3 動的メッセージ（error.meta）

動的メッセージが必要な場合（例：E006 CONFLICT 時の重複内容）は、`error.meta` フィールドに補足情報を含め、UI側でテンプレートに埋め込んで表示します。

**注意**: `error.details` は使用せず、`error.meta` を使用します。詳細は `12-1_API仕様書_型定義.md` を参照してください。

---

## 4. エラーレベル定義

| レベル      | 定義                                                                             | UI上の基本挙動                                             |
| :---------- | :------------------------------------------------------------------------------- | :--------------------------------------------------------- |
| **Warning** | ユーザー操作ミス、業務ルール違反、権限不足など。再操作により回復可能なもの。     | トースト（黄色）、フォーム上のエラー表示、モーダルアラート |
| **Error**   | システム障害、通信断、想定外エラーなど。ユーザー操作では即座に回復不可能なもの。 | トースト（赤色）または専用エラー画面、バナー表示           |

---

## 5. 例外一覧

| 例外ID     | エラーコード (API)         | 内容                     | エラー発生時の処理                               | 利用者向けメッセージ                                       | レベル  |
| :--------- | :------------------------- | :----------------------- | :----------------------------------------------- | :--------------------------------------------------------- | :------ |
| **E001**   | `VALIDATION_ERROR`         | 入力値検証エラー         | 処理中断。フィールド名・理由をレスポンスに含める | 入力内容に誤りがあります。赤枠の項目を確認してください。   | Warning |
| **E002**   | `AUTH_FAILED`              | 認証失敗                 | 認証処理中断。詳細理由は返却しない               | メールアドレスまたはパスワードが間違っています。           | Warning |
| **E003**   | `AUTH_REQUIRED`            | 未認証アクセス           | 処理中断。ログイン画面へリダイレクト             | ログインセッションが切れました。再度ログインしてください。 | Warning |
| **E004**   | `FORBIDDEN`                | 権限不足                 | 処理中断。不正アクセスとしてログ記録             | この操作を行う権限がありません。                           | Warning |
| **E005**   | `NOT_FOUND`                | データ不在               | 処理中断。画面文脈・対象リソースに応じて遷移     | 対象のデータが見つかりません。                             | Warning |
| **E006**   | `CONFLICT`                 | データ重複               | DB制約違反を検知し処理中断                       | （重複内容に応じたメッセージを表示）                       | Warning |
| **E007**   | `LIMIT_EXCEEDED`           | 登録上限超過             | 業務ルールチェックで処理中断                     | 登録上限に達しています。                                   | Warning |
| **E008-1** | `STORAGE_VALIDATION_ERROR` | ファイル形式・サイズ不正 | アップロード前検証で中断                         | ファイルサイズまたは形式が不正です。                       | Warning |
| **E008-2** | `STORAGE_UPLOAD_ERROR`     | ファイル保存失敗         | ストレージ保存処理中断                           | アップロードに失敗しました。                               | Error   |
| **E901**   | `NETWORK_ERROR`            | 通信エラー               | クライアント側で検知                             | 通信エラーが発生しました。                                 | Error   |
| **E999**   | `INTERNAL_SERVER_ERROR`    | 内部システムエラー       | スタックトレースをログ出力                       | システムエラーが発生しました。                             | Error   |

---

## 6. 詳細仕様と対応方針

### 6.1 バリデーションエラー（E001）

- フロントエンド（Zod 等）とバックエンド（DB制約）の両方で検証を行います。
- 本仕様書では、主に**バックエンドから返却されるエラー**を対象とします。

**主な発生箇所**:

- **認証画面**: メール形式不正、パスワードポリシー違反
- **個体登録**: 必須項目不足、未来日指定
- **記録入力**: 数値型不正、文字数超過

### 6.2 認証・権限エラー（E002 / E003 / E004）

- **E002 (認証失敗)**:
  - セキュリティ観点から、具体的理由（メールアドレスの存在有無など）は返却しません。
- **E003 (未認証)**:
  - `supabase.auth.getUser()` 失敗時に発生します。
  - `/login` 画面へ自動遷移（リダイレクト）させます。
- **E004 (権限不足)**:
  - 管理者専用APIへの一般ユーザーアクセスや、他ユーザーのデータ参照（RLS違反）時に発生します。

### 6.3 データ不在エラー（E005）

対象リソースと画面文脈に応じて挙動を切り替えます。

- **対象リソース別の扱い**:
  - **個体 (hedgehog)**: 多頭飼い切り替え中に別端末等で削除された場合など。ホーム画面へ遷移し、個体選択状態を最新に更新します。トーストで「対象の個体は削除されました」と通知します。
  - **記録データ (体重・食事・通院等)**: 一覧画面へ戻し、「既に削除されています」とトースト表示します。
- **画面文脈別の扱い**:
  - **詳細画面 / 直接URLアクセス**: 404画面へ遷移します。
  - **一覧操作中**: 一覧へ戻し、トースト表示します。

### 6.4 データ重複エラー（E006）

重複内容をユーザーが理解できるよう、**動的メッセージ**を使用します。

- **基本方針**: API レスポンスに重複内容を示す `meta` 情報を含め、フロントエンドでテンプレート文に埋め込んで表示します。
- **メッセージ例**:
  - **体重記録**: `同じ日（YYYY-MM-DD）に既に体重が記録されています。`
  - **環境記録**: `この日時には既に記録があります。`
  - **メールアドレス**: `このメールアドレスは既に使用されています。`

### 6.5 業務ルールエラー（E007）

Hariness 固有のルールによる制限です。

- **個体登録数**: **1ユーザー最大10頭**まで。
- **挙動**: 超過時はモーダル等で明示的に通知し、登録をブロックします。

### 6.6 ストレージエラー（E008）

- **E008-1 (Validation)**: クライアント起因（サイズ超過・形式不正）のため、Warningとして扱います。
- **E008-2 (Upload)**: サーバー・ストレージ障害のため、Errorとして扱います。

### 6.7 通信エラー（E901）

- オフライン、タイムアウト等が該当します。
- **Server Actions へ到達しないため ActionResponse は返却されません。**
- クライアント側で独自にハンドリング（`try-catch`等）し、再試行を促します。

### 6.8 システムエラー（E999）

- 想定外のバグやインフラ障害（Supabase ダウン等）です。
- **対応方針**:
  - ユーザーには「どうすればよいか（時間を置く、問い合わせる）」を伝えます。
  - 開発者はログを元に原因調査を行います。

---

## 7. ログ出力方針

| 種別           | ログレベル      | 内容                                       |
| :------------- | :-------------- | :----------------------------------------- |
| **Warning 系** | `warn` / `info` | エラーコード、対象ID、ユーザーID           |
| **Error 系**   | `error`         | スタックトレース、リクエスト情報、発生箇所 |

---

## 8. 画面ID × 例外コード × 遷移先 対応表

各画面において例外が発生した際の**画面遷移・UI挙動**については、別紙を参照してください。

**→ 別紙**: [13_補足）例外仕様_画面ID×例外コード.md]

---

**最終更新日**: 2025年12月18日
