# API仕様書（型定義）

プロジェクト名: Hariness（ハリネス）  
作成日: 2025年12月18日  
作成者: 城田 航  
最終更新日: 2025年12月18日

---

## 1. 概要と目的

### 1.1 概要

本ドキュメントは、Hariness の Server Actions で使用される入出力データ（Request/Response）の型定義を TypeScript 形式で記述したものです。

### 1.2 目的

- APIの入力パラメータと戻り値を厳密に定義し、型安全性（Type Safety）を担保する。
- フロントエンドとバックエンドの開発者間での認識齟齬を防ぐ。
- バリデーションルールの基礎となるデータ構造を明確にする。

---

## 2. 共通レスポンス型

全ての Server Actions は、必ず以下の `ActionResponse` 型を返します。

```typescript
/**
 * Server Actions の共通レスポンス型
 * @template T 成功時のデータ型 (デフォルトは null)
 */
type ActionResponse<T = null> = {
  success: boolean; // 成功: true, 失敗: false
  message?: string; // ユーザー向けメッセージ (例: "保存しました")
  data?: T; // 成功時のデータ (戻り値なしの場合は null)
  error?: {
    // 失敗時の詳細
    code: string; // エラーコード (例: "VALIDATION_ERROR", "AUTH_FAILED" 等)
    meta?: Record<string, unknown>; // 動的メッセージ用の補足情報 (例: E006 CONFLICT時の重複内容)
  };
};
```

### レスポンス例

**✅ 成功時**

```typescript
{
  success: true,
  message: "保存しました",
  data: { id: "123", name: "ハリー" }
}
```

**❌ エラー時**

```typescript
{
  success: false,
  error: {
    code: "VALIDATION_ERROR",
    meta: {
      field: "email",
      message: "メールアドレスの形式が正しくありません"
    }
  }
}
```

**❌ エラー時（E006 CONFLICT例）**

```typescript
{
  success: false,
  error: {
    code: "CONFLICT",
    meta: {
      resource: "weight_record",
      date: "2025-12-18"
    }
  }
}
```

---

## 3. データ型定義（Models & Inputs）

### 3.1 基本型

```typescript
/**
 * 履歴取得の期間指定
 * 'range' を指定した場合は startDate と endDate が必須となる
 */
type HistoryRange = '30d' | '90d' | '180d' | 'range';
```

---

### 3.2 共通モデル (Models) - 戻り値として使用

DBのテーブル定義とほぼ一対一に対応する型です。`ActionResponse<T>` の `data` フィールドで使用されます。

#### ユーザー・個体関連

```typescript
/**
 * ユーザー情報
 */
type User = {
  id: string;
  email: string;
  displayName: string;
  avatarUrl?: string;

  // プロフィール情報
  gender?: 'male' | 'female' | 'unknown'; // DB保存値（英語）。UI表示は別途変換
  ageGroup?: '10s' | '20s' | '30s' | '40s' | '50s' | '60_over';
  prefecture?: string; // 都道府県、海外（列挙値は別途定義）

  role: 'user' | 'admin';

  // 通知設定
  isPushEnabled: boolean;
  isReminderNotificationEnabled: boolean;
  isAlertNotificationEnabled: boolean;
  isNewsNotificationEnabled: boolean;

  // タイムスタンプ (ISO 8601形式)
  createdAt: string;
  lastLoginAt?: string;
  updatedAt: string;
};

/**
 * ハリネズミ個体情報
 */
type Hedgehog = {
  id: string;
  userId: string;
  name: string;

  gender?: 'male' | 'female' | 'unknown'; // オス/メス/不明
  birthDate?: string; // YYYY-MM-DD
  welcomeDate?: string; // YYYY-MM-DD

  imageUrl?: string;
  features?: string; // 見た目の特徴（自由記述）
  insuranceNumber?: string; // ペット保険番号

  createdAt: string; // ISO 8601形式
  updatedAt: string; // ISO 8601形式
};

/**
 * お世話リマインダー
 */
type CareReminder = {
  id: string;
  userId: string;
  title: string; // タイトル
  targetTime: string; // HH:mm:ss形式 (例: "09:00:00")

  isRepeat: boolean;
  frequency?: 'daily' | 'weekly'; // 繰り返し頻度
  daysOfWeek?: string; // 繰り返し曜日 (例: "Mon,Wed")

  isEnabled: boolean; // 有効/無効
  lastCompletedDate?: string; // YYYY-MM-DD (最終完了日)

  createdAt: string; // ISO 8601形式
};
```

#### 健康記録関連

```typescript
/**
 * 体重記録
 */
type WeightRecord = {
  id: string;
  hedgehogId: string;
  weight: number; // 単位: g (整数)
  recordDate: string; // YYYY-MM-DD
  createdAt: string; // ISO 8601形式
};

/**
 * 食事記録
 */
type MealRecord = {
  id: string;
  hedgehogId: string;
  recordDate: string; // YYYY-MM-DD
  recordTime: string; // HH:mm:ss形式

  content: string; // フード名など
  amount?: number; // 量（小数許容）
  amountUnit?: string; // 単位: 'g', 'スプーン' 等

  createdAt: string; // ISO 8601形式
};

/**
 * 排泄記録
 */
type ExcretionRecord = {
  id: string;
  hedgehogId: string;
  recordDate: string; // YYYY-MM-DD
  recordTime: string; // HH:mm:ss形式

  condition: 'normal' | 'abnormal'; // DB保存値（英語）。UI表示は別途変換
  details?: string; // 異常時(軟便、血便など)

  createdAt: string; // ISO 8601形式
};

/**
 * 環境記録 (温湿度)
 */
type EnvironmentRecord = {
  id: string;
  hedgehogId: string;
  recordDate: string; // YYYY-MM-DD

  temperature?: number; // 単位: ℃ (小数許容)
  humidity?: number; // 単位: % (小数許容)

  createdAt: string; // ISO 8601形式
};

/**
 * 投薬記録
 */
type MedicationRecord = {
  id: string;
  hedgehogId: string;
  recordDate: string; // YYYY-MM-DD
  recordTime: string; // HH:mm:ss形式
  medicineName: string;
  createdAt: string; // ISO 8601形式
};

/**
 * メモ記録
 */
type MemoRecord = {
  id: string;
  hedgehogId: string;
  recordDate: string; // YYYY-MM-DD
  content: string;
  createdAt: string; // ISO 8601形式
};

/**
 * 日次記録まとめ
 * getDailyRecords の戻り値として使用
 */
type DailyRecords = {
  weight?: WeightRecord;
  meals: MealRecord[];
  excretions: ExcretionRecord[];
  environment?: EnvironmentRecord;
  medications: MedicationRecord[];
  memo?: MemoRecord;
};
```

#### 通院・カレンダー関連

```typescript
/**
 * 通院記録
 */
type HospitalVisit = {
  id: string;
  hedgehogId: string;
  visitDate: string; // YYYY-MM-DD

  diagnosis?: string; // 診断名
  treatment?: string; // 治療内容

  // 処方薬リスト
  medicinePrescription?: {
    name: string;
    note?: string;
  }[];

  nextVisitDate?: string; // YYYY-MM-DD
  createdAt: string; // ISO 8601形式
};

/**
 * カレンダーイベント
 * (通常のイベントと通院記録を統合して扱う)
 */
type CalendarEvent = {
  id: string;
  type: 'event' | 'visit';
  date: string; // YYYY-MM-DD
  title: string;
  visitData?: HospitalVisit; // type='visit'の時のみ存在
};
```

#### 通知・お知らせ関連

```typescript
/**
 * お知らせ (管理者作成)
 */
type News = {
  id: string;
  title: string;
  content: string;

  isPublished: boolean;
  publishedAt?: string; // ISO 8601形式（予約投稿用）

  createdBy?: string; // 作成者ID (管理者)
  createdAt: string; // ISO 8601形式
  updatedAt: string; // ISO 8601形式
};

/**
 * 通知アイテム
 * (お知らせとアラートを統合して扱う)
 */
type NotificationItem = {
  id: string;
  type: 'news' | 'alert';
  title: string;
  content: string;
  isRead: boolean;
  createdAt: string; // ISO 8601形式
};
```

---

### 3.3 入力パラメータ (Inputs) - 引数として使用

画面から送られてくるデータの型です。Server Actions の引数として使用されます。

#### 認証系

```typescript
type SignUpInput = {
  email: string;
  password: string;
  redirectUrl: string; // メール検証後のリダイレクト先URL
};

type SignInInput = {
  email: string;
  password: string;
};
```

#### プロフィール・通知設定

```typescript
/**
 * プロフィール更新用入力
 */
type UpdateProfileInput = {
  displayName: string;
  avatarUrl?: string;
  gender?: 'male' | 'female' | 'unknown'; // DB保存値（英語）
  ageGroup?: '10s' | '20s' | '30s' | '40s' | '50s' | '60_over';
  prefecture?: string; // 都道府県、海外（列挙値は別途定義）
};

/**
 * 通知設定更新用入力
 */
type NotificationSettingsInput = {
  isPushEnabled: boolean; // プッシュ通知全体のON/OFF
  isReminderEnabled: boolean; // リマインダー通知のON/OFF
  isAlertEnabled: boolean; // アラート通知のON/OFF
  isNewsEnabled: boolean; // お知らせ通知のON/OFF
};
```

#### 個体登録・更新

```typescript
/**
 * 個体新規登録用入力
 */
type CreateHedgehogInput = {
  name: string;
  gender?: 'male' | 'female' | 'unknown'; // オス/メス/不明
  birthDate?: string; // YYYY-MM-DD
  welcomeDate?: string; // YYYY-MM-DD
  features?: string; // 見た目の特徴（自由記述）
  insuranceNumber?: string; // ペット保険番号
};

/**
 * 個体情報更新用入力 (一部更新可)
 * @note name は更新時も必須とするか任意とするかは実装時に決定
 */
type UpdateHedgehogInput = Partial<CreateHedgehogInput> & {
  name?: string; // 明示的に記載（更新時は任意とする想定）
};
```

#### リマインダー登録

```typescript
/**
 * リマインダー登録・更新用入力
 */
type CareReminderInput = {
  id?: string; // 更新時は必須
  title: string; // タイトル (薬、ごはん等)
  targetTime: string; // HH:mm:ss形式 (例: "09:00:00")

  isRepeat: boolean;
  frequency?: 'daily' | 'weekly'; // 繰り返し頻度

  // 繰り返し曜日 (例: ["Mon", "Wed"])
  // ※保存時に "Mon,Wed" 形式の文字列に変換される
  daysOfWeek?: ('Mon' | 'Tue' | 'Wed' | 'Thu' | 'Fri' | 'Sat' | 'Sun')[];
};
```

#### 日次記録一括保存

```typescript
/**
 * 日次記録一括保存用入力
 * 指定日の全記録をまとめて送信する
 */
type DailyRecordBatchInput = {
  weight?: number; // 単位: g (整数)
  temperature?: number; // 単位: ℃ (小数許容)
  humidity?: number; // 単位: % (小数許容)

  meals?: {
    id?: string; // 更新時は必須（新規作成時は省略）
    time: string; // HH:mm:ss形式
    content: string; // フード名など
    amount?: number; // 量（小数許容）
    amountUnit?: string; // 単位: 'g', 'スプーン' 等
  }[];

  excretions?: {
    id?: string; // 更新時は必須（新規作成時は省略）
    time: string; // HH:mm:ss形式
    condition: 'normal' | 'abnormal'; // DB保存値（英語）。UI表示は別途変換
    details?: string; // 異常時(軟便、血便など)
  }[];

  medications?: {
    id?: string; // 更新時は必須（新規作成時は省略）
    time: string; // HH:mm:ss形式
    name: string; // 薬の名前
  }[];

  memo?: string; // メモ内容
};
```

#### 通院記録登録

```typescript
/**
 * 通院記録登録・更新用入力
 */
type HospitalVisitInput = {
  id?: string; // 更新時は必須
  hedgehogId: string;
  visitDate: string; // YYYY-MM-DD

  diagnosis?: string; // 診断名
  treatment?: string; // 治療内容

  medicinePrescription?: {
    name: string; // 薬の名前
    note?: string; // 備考
  }[];

  nextVisitDate?: string; // YYYY-MM-DD
};
```

#### カレンダーイベント登録

```typescript
/**
 * カレンダーイベント登録・更新用入力
 */
type CalendarEventInput = {
  id?: string; // 更新時は必須
  date: string; // YYYY-MM-DD
  title: string; // イベント名（自由記述）
};
```

#### 管理者機能

```typescript
/**
 * 管理ダッシュボード統計情報
 */
type AdminDashboardStats = {
  totalUsers: number; // 総ユーザー数
  totalUsersChange: number; // 前日比（増減数、正の値は増加、負の値は減少）
  totalHedgehogs: number; // 登録個体数
  totalHedgehogsChange: number; // 前日比（増減数、正の値は増加、負の値は減少）
  activeUsersLast30Days: number; // 直近30日のアクティブユーザー数
};

/**
 * お知らせ作成用入力
 */
type CreateNewsInput = {
  title: string;
  content: string;
  isPublished: boolean; // 公開フラグ
  publishedAt?: string; // ISO 8601形式（予約投稿用）
};

/**
 * データエクスポート種別
 * @note 'vitals' を選択すると、体重・食事・排泄・環境・投薬・メモの6ファイルが生成される
 */
type ExportType =
  | 'users' // ユーザーマスタ
  | 'hedgehogs' // 個体マスタ
  | 'vitals' // バイタル記録（体重・食事・排泄・環境・投薬・メモ）
  | 'visits' // 通院記録
  | 'reminders' // リマインダー設定
  | 'alerts' // アラート履歴
  | 'withdrawals' // 退会ログ
  | 'summary'; // 分析用サマリー

/**
 * エクスポート機能の入力パラメータ
 * @note startDate, endDate は YYYYMMDD 形式（ハイフンなし）
 */
type ExportDataInput = {
  types: ExportType[];
  startDate: string; // YYYYMMDD 形式
  endDate: string; // YYYYMMDD 形式
};
```

---
