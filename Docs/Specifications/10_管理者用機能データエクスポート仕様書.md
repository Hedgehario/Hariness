**プロジェクト名**: Hariness（ハリネス）  
**作成日**: 2025年12月18日  
**更新日**: 2026年1月19日  
**作成者**: 城田 航

---

## 1. エクスポート仕様の概要

管理者がシステム内のデータを分析・バックアップするために、CSV形式でデータを出力する機能です。
提供されたUIデザイン（管理者ダッシュボード → データエクスポート画面）に基づき、以下の仕様で実装します。

### 1.1 CSVフォーマット定義

Excel等での利用を前提とした標準的な形式を採用します。

- **文字コード**: `UTF-8 (BOM付き)` ※Excelでの文字化け防止のため必須
- **改行コード**: `CRLF` (Windows互換)
- **区切り文字**: `,` (カンマ)
- **ヘッダー行**: あり（1行目に物理カラム名を出力）
- **値の囲み**: 文字列にカンマや改行が含まれる可能性がある項目（`content`, `details`, `diagnosis` 等）は、必ずダブルクォート `"` で囲む。

---

## 2. エクスポート項目一覧

UI上の「出力データ」チェックボックスに対応する詳細な出力内容です。
**UI上の分類（バイタル記録など）でチェックされた場合、対応する複数のテーブル（体重・食事・排泄など）のCSVが個別に生成されます。**

### 2.1 ユーザーマスタ (`USERS`)

- **ファイル名**: `hariness_export_users_{startDate}-{endDate}.csv`
- **※日付形式**: `YYYYMMDD`
- **出力目的**: 地域、年代、アクティブ率の分析

| カラム名        | 説明                  | 備考                |
| :-------------- | :-------------------- | :------------------ |
| `id`            | 会員ID                |                     |
| `prefecture`    | 住所（都道府県/海外） |                     |
| `age_group`     | 年代区分              |                     |
| `gender`        | 性別                  | 男/女/無回答        |
| `created_at`    | 登録日時              | YYYY-MM-DD HH:mm:ss |
| `last_login_at` | 最終ログイン日時      | アクティブ判定用    |

### 2.2 個体マスタ (`HEDGEHOGS`)

- **ファイル名**: `hariness_export_hedgehogs_{startDate}-{endDate}.csv`
- **※日付形式**: `YYYYMMDD`
- **出力目的**: 飼育個体の属性分析

| カラム名        | 説明           | 備考           |
| :-------------- | :------------- | :------------- |
| `id`            | 個体ID         |                |
| `user_id`       | 飼い主ID       |                |
| `gender`        | 性別           | オス/メス/不明 |
| `birth_date`    | 生年月日       |                |
| `welcome_date`  | お迎え日       |                |
| `age_months`    | 現在月齢       | ※出力時に算出  |
| `has_insurance` | ペット保険有無 | `true`/`false` |

### 2.3 バイタル記録 (6種) ※UI上は1つのチェックボックス

UIで「バイタル記録」を選択すると、以下の6ファイルが出力されます。

- **※日付形式**: `YYYYMMDD`

#### (1) 体重記録 (`WEIGHT_RECORDS`)

- **ファイル名**: `hariness_export_weights_{startDate}-{endDate}.csv`

| カラム名      | 説明    | 備考 |
| :------------ | :------ | :--- |
| `id`          | 記録ID  |      |
| `hedgehog_id` | 個体ID  |      |
| `record_date` | 記録日  |      |
| `weight`      | 体重(g) |      |

#### (2) 食事記録 (`MEAL_RECORDS`)

- **ファイル名**: `hariness_export_meals_{startDate}-{endDate}.csv`

| カラム名      | 説明     | 備考 |
| :------------ | :------- | :--- |
| `id`          | 記録ID   |      |
| `hedgehog_id` | 個体ID   |      |
| `record_date` | 記録日   |      |
| `record_time` | 記録時刻 |      |
| `content`     | 食事内容 |      |
| `amount`      | 量       |      |
| `amount_unit` | 単位     |      |

#### (3) 排泄記録 (`EXCRETION_RECORDS`)

- **ファイル名**: `hariness_export_excretions_{startDate}-{endDate}.csv`

| カラム名      | 説明     | 備考                     |
| :------------ | :------- | :----------------------- |
| `id`          | 記録ID   |                          |
| `hedgehog_id` | 個体ID   |                          |
| `record_date` | 記録日   |                          |
| `record_time` | 記録時刻 |                          |
| `type`        | 種別     | うんち／おしっこ／その他 |
| `condition`   | 状態     | 正常／異常               |
| `details`     | 詳細メモ | 異常時の内容             |

#### (4) 環境記録 (`ENVIRONMENT_RECORDS`)

- **ファイル名**: `hariness_export_environment_{startDate}-{endDate}.csv`

| カラム名      | 説明    | 備考 |
| :------------ | :------ | :--- |
| `id`          | 記録ID  |      |
| `hedgehog_id` | 個体ID  |      |
| `record_date` | 記録日  |      |
| `temperature` | 気温(℃) |      |
| `humidity`    | 湿度(%) |      |

#### (5) 投薬記録 (`MEDICATION_RECORDS`)

- **ファイル名**: `hariness_export_medications_{startDate}-{endDate}.csv`

| カラム名        | 説明     | 備考 |
| :-------------- | :------- | :--- |
| `id`            | 記録ID   |      |
| `hedgehog_id`   | 個体ID   |      |
| `record_date`   | 記録日   |      |
| `record_time`   | 記録時刻 |      |
| `medicine_name` | 薬の名前 |      |

#### (6) メモ記録 (`MEMO_RECORDS`)

- **ファイル名**: `hariness_export_memos_{startDate}-{endDate}.csv`

| カラム名      | 説明     | 備考     |
| :------------ | :------- | :------- |
| `id`          | 記録ID   |          |
| `hedgehog_id` | 個体ID   |          |
| `record_date` | 記録日   |          |
| `content`     | メモ内容 | 自由記述 |

### 2.4 通院記録 (`HOSPITAL_VISITS`)

- **ファイル名**: `hariness_export_visits_{startDate}-{endDate}.csv`
- **※日付形式**: `YYYYMMDD`
- **出力目的**: 病気の傾向分析

| カラム名                | 説明         | 備考                            |
| :---------------------- | :----------- | :------------------------------ |
| `id`                    | 診察ID       |                                 |
| `hedgehog_id`           | 個体ID       |                                 |
| `visit_date`            | 診療日       |                                 |
| `diagnosis`             | 診療内容     | 自由記述                        |
| `medicine_prescription` | 処方薬リスト | 薬名をスラッシュ`/`区切りで連結 |

### 2.5 リマインダー設定 (`CARE_REMINDERS`)

- **ファイル名**: `hariness_export_reminders_{startDate}-{endDate}.csv`
- **※日付形式**: `YYYYMMDD`
- **出力目的**: ユーザーが何を重要視しているかの分析

| カラム名      | 説明           | 備考 |
| :------------ | :------------- | :--- |
| `id`          | リマインダーID |      |
| `user_id`     | 飼い主ID       |      |
| `target_time` | 通知時刻       |      |
| `title`       | タイトル       |      |

### 2.6 アラート履歴 (`ALERT_HISTORY`)

- **ファイル名**: `hariness_export_alerts_{startDate}-{endDate}.csv`
- **※日付形式**: `YYYYMMDD`
- **出力目的**: 異常検知の発生頻度分析

| カラム名      | 説明         | 備考                        |
| :------------ | :----------- | :-------------------------- |
| `id`          | アラートID   |                             |
| `hedgehog_id` | 個体ID       |                             |
| `alert_type`  | アラート種別 | `weight_loss`, `no_food` 等 |
| `created_at`  | 検知日時     |                             |

### 2.7 退会ログ (`WITHDRAWAL_LOGS`)

- **ファイル名**: `hariness_export_withdrawals_{startDate}-{endDate}.csv`
- **※日付形式**: `YYYYMMDD`
- **出力目的**: 退会理由および退会ユーザーの属性分析
- **※注意**: 個人を特定できる情報 (`email`等) はハッシュ化または削除されています。

| カラム名         | 説明                   | 備考                 |
| :--------------- | :--------------------- | :------------------- |
| `id`             | ログID                 |                      |
| `user_id`        | ユーザーID             | 元のユーザーID       |
| `email_hash`     | メールアドレスハッシュ | 照合用（ハッシュ値） |
| `reason`         | 退会理由               |                      |
| `withdrawn_at`   | 退会日時               |                      |
| `age_group`      | 年代                   | 退会時の属性         |
| `gender`         | 性別                   | 退会時の属性         |
| `prefecture`     | 居住地                 | 退会時の属性         |
| `hedgehog_count` | 飼育頭数               | 退会時の頭数         |
| `days_used`      | 利用日数               | 登録〜退会までの日数 |

### 2.8 分析用サマリー (`SUMMARY_REPORT`)

- **ファイル名**: `hariness_export_summary_{startDate}-{endDate}.csv`
- **※日付形式**: `YYYYMMDD`
- **出力目的**: 分析の手間を削減するための結合済みデータ（ワンクリック分析用）

| カラム名          | 説明       | 備考                                         |
| :---------------- | :--------- | :------------------------------------------- |
| `hedgehog_id`     | 個体ID     |                                              |
| `user_prefecture` | 飼い主住所 |                                              |
| `user_age_group`  | 飼い主年代 |                                              |
| `gender`          | 個体性別   |                                              |
| `age_months`      | 現在月齢   |                                              |
| `avg_weight`      | 平均体重   | 期間内の平均                                 |
| `record_days`     | 記録日数   | データの信頼度（期間内に体重を記録した日数） |
| `alert_count`     | アラート数 | 期間内の合計                                 |
| `visit_count`     | 通院回数   | アラート後の行動分析用（期間内の通院回数）   |

---

## 3. UI/UX設計（画像に基づく仕様）

### 3.1 画面構成要素

- **戻るボタン**: 管理者ダッシュボードへ戻る。
- **期間選択**:
  - `[全期間]` / `[範囲指定]` のセグメントコントロール（トグル）。
  - 「範囲指定」選択時のみ、日付ピッカー（開始日〜終了日）を表示。
- **出力データ選択**:
  - チェックボックスリスト。
  - 項目: `ユーザーマスタ`, `個体マスタ`, `バイタル記録` (体重/食事/排泄/環境/投薬/メモ), `通院記録`, `リマインダー設定`, `アラート履歴`, `退会ログ`, `分析用サマリー`。
  - **「すべて選択」機能**をリスト上部に配置（推奨）。
- **CSV出力ボタン**:
  - 画面最下部に固定（Sticky Footerではないが、コンテンツ量によってはスクロール必要）。
  - 初期状態または0件時は非活性（Disabled）にはせず、押下時に判定。

### 3.2 インタラクションフロー

1.  **ボタン押下**:
    - ボタンラベルが `CSV出力する` → `作成中...`（スピナー）に変化。
    - 画面全体を透明なオーバーレイで覆い、操作をブロック（二重送信防止）。
2.  **ZIP圧縮（複数ファイルの場合）**:
    - チェックボックスで複数の項目（例：バイタル記録を選択すると6ファイル生成される）が選ばれた場合、**個別にダウンロードさせるとブラウザがブロックする場合があるため、1つのZIPファイル (`hariness_export_{YYYYMMDD}.zip`) にまとめてダウンロードさせる。**
3.  **完了通知**:
    - 画面下部に「✅ エクスポートが完了しました」というトーストを表示。
    - 完了画面への遷移はしない（そのまま連続操作可能）。

### 3.3 エラーハンドリング (`13_例外仕様書.md` 準拠)

- **権限エラー (E004)**:
  - 不正なアクセスとみなし、操作をブロックします（トーストまたは権限エラーモーダル）。
- **対象データなし (E005相当)**:
  - 「⚠️ 対象データがありません」というトーストを表示してダウンロードを中断します（空ファイルの生成は行いません）。
- **通信エラー (E901)**:
  - 「通信エラーが発生しました」というトーストを表示し、再試行を促します。
- **サーバーエラー (E999)**:
  - 画面上部に赤色のバナーで「❌ データの生成に失敗しました」と表示します。

---

## 4. API実装への要求 (`12_API仕様書.md` との整合)

この仕様を実現するために、API側 (`exportDataAsCsv`) は以下の挙動に対応する必要があります。

- **入力**: `type` パラメータは配列を受け取るか、カンマ区切り文字列とする（複数選択に対応するため）。
  - 例: `exportDataAsCsv({ types: ['users', 'vitals'], ... })`
- **出力**: 常に Blob 形式を返却する。
  - 単一選択時: `text/csv` の Blob
  - 複数選択時: `application/zip` の Blob
