**プロジェクト名**: Hariness（ハリネス）  
**作成日**: 2025年12月18日  
**更新日**: 2026年1月19日  
**作成者**: 城田 航
**改版**: v2.0（自動テスト対応版）

---

## 1. 概要

本ドキュメントは、Hariness の品質保証のためのテスト設計書です。

MVPリリースにおけるコア体験（記録・閲覧・管理）の品質を保証し、予期せぬデータ不整合やユーザー離脱を防ぐための最終テスト項目を定義します。認証・セキュリティ、データ整合性、UX、システム安定性の各観点から、優先度（P0/P1）を明確にしたテストケースを網羅的に整理しています。

### 1.1 テスト種別

| 種別 | ツール | 対象 | 自動化 |
|------|-------|------|--------|
| **ユニットテスト** | Vitest | バリデーションスキーマ、ユーティリティ関数 | ✅ |
| **統合テスト** | Vitest + Mock | Server Actions（認証・DB操作） | ✅ |
| **E2Eテスト** | Playwright | ユーザーフロー全体 | ✅ |
| **手動テスト** | - | RLS、PWA、UI/UX確認 | ❌ |

---

## 2. 目的

本ドキュメントの目的は以下の通りです：

1. **品質保証の体系化**: MVPリリース前に検証すべき項目を網羅的に整理し、テスト漏れを防止します。
2. **優先度の明確化**: P0（必須・MVP）とP1（推奨・V1.x以降）を明確に区別し、リリース前のテスト工数を最適化します。
3. **テスト実施の標準化**: テスト項目ごとに手順と期待結果を明確に定義し、テスト実施者間での認識のずれを防ぎます。
4. **回帰テストの基盤構築**: 将来の機能追加や変更時に、既存機能への影響を確認するためのテストケースを提供します。
5. **自動化によるCI/CD対応**: 継続的インテグレーションでの自動テスト実行を可能にします。

---

## 3. テスト実施方針

- **重点検証項目**:  
  認証のセキュリティ（RLSによる完全なデータ分離）、日次記録の一括保存ロジック（Server Actionsによる原子性）、個体削除時の連鎖削除、オフライン/タイムアウト耐性。
- **環境**:  
  PWA（iOS / Android ブラウザ）、Supabase（開発 / 本番環境）。
- **優先度**:  
  🟢 = P0（必須・MVP） / 🟡 = P1（推奨・V1.x以降）
- **自動化**:
  🤖 = 自動テスト実装済 / 👤 = 手動テスト必要

---

## 4. 認証・ユーザー管理・セキュリティ（AUTH）

| ID         | カテゴリ   | テスト項目         | 手順                                                               | 期待される結果                                                                                                         | 優先度 | 自動化 |
| ---------- | ---------- | ------------------ | ------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------- | ------ | ------ |
| TC-AUTH-01 | 新規登録   | 重複登録防止       | 既登録メールで新規登録を試行                                       | 登録が失敗し、`E006 (CONFLICT)` またはAuth由来の重複エラーが返却される。表示文言は「このメールは既に登録されています」 | 🟢     | 🤖     |
| TC-AUTH-02 | 認証       | パスワードポリシー（8文字未満） | 8文字未満のパスワードで登録を試みる                                | `E001 (VALIDATION_ERROR)` によりブロックされる。表示文言は「パスワードは8文字以上で入力してください」                  | 🟢     | 🤖     |
| TC-AUTH-03 | 認証       | パスワード確認不一致 | パスワードと確認用パスワードが不一致で登録を試みる                 | `E001 (VALIDATION_ERROR)` によりブロックされる。表示文言は「パスワードが一致しません」                                 | 🟢     | 🤖     |
| TC-AUTH-04 | 認証       | メールアドレス形式 | 不正な形式のメールアドレスで登録を試みる                           | `E001 (VALIDATION_ERROR)` によりブロックされる                                                                         | 🟢     | 🤖     |
| TC-AUTH-05 | 退会       | 物理削除とログ     | S13で退会を実行し、Supabase StudioでDBを確認                       | ユーザーおよび関連データは物理削除され、`WITHDRAWAL_LOGS` にPIIを含まない匿名ログが記録される                          | 🟢     | 👤     |
| TC-AUTH-06 | 認可       | RLS（個体）        | ユーザーAでログインし、ユーザーBの個体IDに対し取得/更新/削除を試行 | いずれも成功せず、DB上のデータは一切変更されない。UIは共通例外で処理                                                   | 🟢     | 👤     |
| TC-AUTH-07 | 認可       | RLS（記録）        | ユーザーAが、ユーザーBの健康記録IDを指定して更新                   | 更新されず、DBは不変（RLS違反）                                                                                        | 🟢     | 👤     |
| TC-AUTH-08 | セッション | 期限切れ挙動       | 入力中に放置→期限切れ後に保存                                      | `E003 (AUTH_REQUIRED)` によりログイン画面へ遷移                                                                        | 🟢     | 👤     |
| TC-AUTH-09 | 認証       | 空フィールド       | メールアドレスまたはパスワードを空で送信                           | `E001 (VALIDATION_ERROR)` によりブロックされる                                                                         | 🟢     | 🤖     |

---

## 5. 個体管理（HH）

| ID       | カテゴリ | テスト項目              | 手順                                              | 期待される結果                                                                            | 優先度 | 自動化 |
| -------- | -------- | ----------------------- | ------------------------------------------------- | ----------------------------------------------------------------------------------------- | ------ | ------ |
| TC-HH-01 | 登録制限 | 最大頭数                | 11頭目の登録                                      | `E007 (LIMIT_EXCEEDED)` で登録ブロック                                                    | 🟢     | 🤖     |
| TC-HH-02 | 整合性   | 連鎖削除                | 個体を削除                                        | 紐づく体重/食事/通院等がDB制約で自動削除                                                  | 🟢     | 👤     |
| TC-HH-03 | バリデーション | 名前必須           | 名前を空で保存                                    | `E001 (VALIDATION_ERROR)` で保存不可                                                      | 🟢     | 🤖     |
| TC-HH-04 | バリデーション | 名前文字数上限     | 21文字以上の名前で保存                            | `E001 (VALIDATION_ERROR)` で保存不可（20文字制限）                                        | 🟢     | 🤖     |
| TC-HH-05 | バリデーション | 未来の生年月日     | 未来の日付を生年月日として入力                    | `E001 (VALIDATION_ERROR)` で保存不可                                                      | 🟢     | 🤖     |
| TC-HH-06 | バリデーション | 未来の迎えた日     | 未来の日付を迎えた日として入力                    | `E001 (VALIDATION_ERROR)` で保存不可                                                      | 🟢     | 🤖     |
| TC-HH-07 | 画像処理 | ストレージアップロード  | P10で個体写真をアップロード                       | Supabase Storageに保存され、`image_url`が更新される。再読み込み後も画像が正しく表示される | 🟢     | 👤     |
| TC-HH-08 | 画像検証 | ファイルサイズ上限     | 5MB超の画像をアップロード                         | `E008-1 (STORAGE_VALIDATION)` によりブロックされる                                        | 🟢     | 🤖     |
| TC-HH-09 | 画像検証 | 不正ファイル形式       | PDFファイルをアップロード                         | `E008-1 (STORAGE_VALIDATION)` によりブロックされる                                        | 🟢     | 🤖     |
| TC-HH-10 | 画像検証 | 許可ファイル形式       | JPEG/PNG/WebP形式の画像をアップロード             | 正常にアップロードされる                                                                  | 🟢     | 🤖     |
| TC-HH-11 | UI       | ゼロ状態                | 全個体削除後にホーム表示                          | クラッシュせず、個体登録を促す初期UI                                                      | 🟢     | 👤     |

---

## 6. 健康記録：一括保存ロジック（VR）

| ID       | カテゴリ | テスト項目                 | 手順                                                                                                   | 期待される結果                                                                                                        | 優先度 | 自動化 |
| -------- | -------- | -------------------------- | ------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------- | ------ | ------ |
| TC-VR-01 | 記録操作 | 一括CRUD                   | 食事1件追加/1件修正/1件除外で保存                                                                      | 追加・修正・除外（物理削除）が1トランザクションで完了                                                                 | 🟢     | 🤖     |
| TC-VR-02 | 原子性   | トランザクション           | 正常+異常（31文字超）同時送信                                                                          | 全処理ロールバック、DBに不完全データなし                                                                              | 🟢     | 🤖     |
| TC-VR-03 | 整合性   | 環境入力任意               | 気温/湿度を両方空で保存                                                                                | 環境レコードは作成されない。他の記録は保存                                                                            | 🟢     | 🤖     |
| TC-VR-04 | 精度     | 数値型                     | 気温に25.5を入力                                                                                       | 小数のまま保存・グラフ反映                                                                                            | 🟢     | 🤖     |
| TC-VR-05 | 排他制御 | 同時実行                   | 同一個体・同日に2端末同時保存                                                                          | DBは1件の正しい状態に収束。失敗側はエラー/再読込                                                                      | 🟢     | 👤     |
| TC-VR-06 | 重複制約 | 同日重複制約（体重・環境） | ・同一日に体重を2回入力して保存する<br>または<br>・同一日に環境記録（気温・湿度）を2回入力して保存する | `E006 (CONFLICT)` により重複保存が防止される（DBのUNIQUE制約）                                                        | 🟢     | 👤     |
| TC-VR-07 | 境界値   | 体重0g許可                 | 体重に0を入力                                                                                          | 正常に保存される                                                                                                      | 🟢     | 🤖     |
| TC-VR-08 | 境界値   | 体重2999g許可              | 体重に2999gを入力                                                                                      | 正常に保存される（上限内）                                                                                            | 🟢     | 🤖     |
| TC-VR-09 | 境界値   | 体重null許可               | 体重を空のまま保存                                                                                     | 正常に保存される（任意項目）                                                                                          | 🟢     | 🤖     |
| TC-VR-10 | 境界値   | 湿度0%許可                 | 湿度に0%を入力                                                                                         | 正常に保存される                                                                                                      | 🟢     | 🤖     |
| TC-VR-11 | 境界値   | 湿度100%許可               | 湿度に100%を入力                                                                                       | 正常に保存される（上限）                                                                                              | 🟢     | 🤖     |
| TC-VR-12 | 整合性   | 食事内容30文字許可         | 食事内容に30文字入力                                                                                   | 正常に保存される                                                                                                      | 🟢     | 🤖     |
| TC-VR-13 | 整合性   | 食事内容31文字エラー       | 食事内容に31文字入力                                                                                   | `E001 (VALIDATION_ERROR)` でブロックされる（30文字制限）                                                              | 🟢     | 🤖     |
| TC-VR-14 | 整合性   | 食事内容空エラー           | 食事内容を空文字で入力                                                                                 | `E001 (VALIDATION_ERROR)` でブロックされる（1文字以上必須）                                                           | 🟢     | 🤖     |
| TC-VR-15 | 整合性   | 食事内容1文字許可          | 食事内容に1文字入力                                                                                    | 正常に保存される                                                                                                      | 🟢     | 🤖     |
| TC-VR-16 | 整合性   | 排泄記録の種別必須         | 排泄記録に種別（type）を指定しない状態で保存                                                           | `E001 (VALIDATION_ERROR)` でブロックされる（type は必須: urine/stool/other）                                          | 🟢     | 🤖     |
| TC-VR-17 | 整合性   | 排泄異常時の詳細必須       | 排泄を異常（abnormal）として、詳細を空のまま保存                                                       | `E001 (VALIDATION_ERROR)` でブロックされる（異常時は詳細必須）                                                        | 🟢     | 🤖     |
| TC-VR-18 | 整合性   | 投薬名必須                 | 投薬記録で薬の名前を空で保存                                                                           | `E001 (VALIDATION_ERROR)` でブロックされる                                                                            | 🟢     | 🤖     |
| TC-VR-19 | 整合性   | 投薬名50文字上限           | 投薬記録で51文字の薬名を入力                                                                           | `E001 (VALIDATION_ERROR)` でブロックされる                                                                            | 🟢     | 🤖     |
| TC-VR-20 | 整合性   | メモ1000文字上限           | メモに1001文字入力                                                                                     | `E001 (VALIDATION_ERROR)` でブロックされる                                                                            | 🟢     | 🤖     |

---

## 7. 通院記録（HV）

| ID       | カテゴリ   | テスト項目              | 手順                                             | 期待される結果                                                    | 優先度 | 自動化 |
| -------- | ---------- | ----------------------- | ------------------------------------------------ | ----------------------------------------------------------------- | ------ | ------ |
| TC-HV-01 | バリデーション | ハリネズミID必須    | ハリネズミIDを指定せずに保存                     | `E001 (VALIDATION_ERROR)` でブロックされる                        | 🟢     | 🤖     |
| TC-HV-02 | バリデーション | 受診日必須          | 受診日を指定せずに保存                           | `E001 (VALIDATION_ERROR)` でブロックされる                        | 🟢     | 🤖     |
| TC-HV-03 | バリデーション | タイトル100文字上限 | 101文字のタイトルを入力                          | `E001 (VALIDATION_ERROR)` でブロックされる                        | 🟢     | 🤖     |
| TC-HV-04 | バリデーション | 診断名500文字上限   | 501文字の診断名を入力                            | `E001 (VALIDATION_ERROR)` でブロックされる                        | 🟢     | 🤖     |
| TC-HV-05 | バリデーション | 治療内容500文字上限 | 501文字の治療内容を入力                          | `E001 (VALIDATION_ERROR)` でブロックされる                        | 🟢     | 🤖     |
| TC-HV-06 | バリデーション | 薬名必須            | 処方薬の名前を空で追加                           | `E001 (VALIDATION_ERROR)` でブロックされる                        | 🟢     | 🤖     |
| TC-HV-07 | バリデーション | 薬名50文字上限      | 51文字の薬名を入力                               | `E001 (VALIDATION_ERROR)` でブロックされる                        | 🟢     | 🤖     |
| TC-HV-08 | 連携       | 次回診察連動           | 次回診察日を登録                                 | カレンダーに予定マーカーが自動表示される                          | 🟢     | 👤     |

---

## 8. カレンダー・イベント（CAL）

| ID        | カテゴリ   | テスト項目            | 手順                                | 期待される結果                                     | 優先度 | 自動化 |
| --------- | ---------- | --------------------- | ----------------------------------- | -------------------------------------------------- | ------ | ------ |
| TC-CAL-01 | バリデーション | タイトル必須      | タイトルを空で保存                  | `E001 (VALIDATION_ERROR)` でブロックされる         | 🟢     | 🤖     |
| TC-CAL-02 | バリデーション | タイトル100文字上限| 101文字のタイトルを入力             | `E001 (VALIDATION_ERROR)` でブロックされる         | 🟢     | 🤖     |
| TC-CAL-03 | バリデーション | 日付必須          | 日付を指定せずに保存                | `E001 (VALIDATION_ERROR)` でブロックされる         | 🟢     | 🤖     |
| TC-CAL-04 | 表示       | 誕生日自動表示        | ハリネズミの誕生日月にカレンダー表示 | 誕生日イベントが自動的に表示される                 | 🟢     | 👤     |
| TC-CAL-05 | 表示       | 通院履歴表示          | 通院記録がある月にカレンダー表示    | 通院イベントが正しく表示される                     | 🟢     | 👤     |

---

## 9. リマインダー（REM）

| ID        | カテゴリ   | テスト項目            | 手順                                  | 期待される結果                                     | 優先度 | 自動化 |
| --------- | ---------- | --------------------- | ------------------------------------- | -------------------------------------------------- | ------ | ------ |
| TC-REM-01 | バリデーション | タイトル必須      | タイトルを空で保存                    | `E001 (VALIDATION_ERROR)` でブロックされる         | 🟢     | 🤖     |
| TC-REM-02 | バリデーション | タイトル50文字上限| 51文字のタイトルを入力                | `E001 (VALIDATION_ERROR)` でブロックされる         | 🟢     | 🤖     |
| TC-REM-03 | バリデーション | 時間形式          | 不正な時間形式（25:00等）を入力       | `E001 (VALIDATION_ERROR)` でブロックされる         | 🟢     | 🤖     |
| TC-REM-04 | ロジック   | 1回のみ完了後無効化   | 繰り返しOFFで完了→翌日確認            | `is_enabled=false` に自動遷移                      | 🟢     | 👤     |
| TC-REM-05 | ロジック   | 完了状態トグル        | リマインダーを完了状態に切り替え      | `last_completed_date`が今日の日付に更新される      | 🟢     | 👤     |

---

## 10. システム・ネットワーク（SYS）

| ID        | カテゴリ   | テスト項目       | 手順                        | 期待される結果                                  | 優先度 | 自動化 |
| --------- | ---------- | ---------------- | --------------------------- | ----------------------------------------------- | ------ | ------ |
| TC-SYS-01 | 回線       | ネットワーク遮断 | オフライン保存→復帰後再試行 | `E901 (NETWORK_ERROR)` 表示、入力保持で再送可能 | 🟢     | 👤     |
| TC-SYS-02 | キャッシュ | PWA更新          | 新版デプロイ後に起動        | 旧キャッシュに阻害されず最新版適用              | 🟡     | 👤     |

---

## 11. 管理者機能（ADM）

| ID        | カテゴリ | テスト項目       | 手順                              | 期待される結果                     | 優先度 | 自動化 |
| --------- | -------- | ---------------- | --------------------------------- | ---------------------------------- | ------ | ------ |
| TC-ADM-01 | 出力     | エクスポート形式 | 管理画面からCSV出力（単体/複数）  | 単体CSV、複数ZIPで適切な文字コード | 🟡     | 👤     |
| TC-ADM-02 | 防御     | 権限ガード       | 一般ユーザーで `ADM00` 直アクセス | `E004 (FORBIDDEN)`、ホームへ遷移   | 🟡     | 👤     |

---

## 12. テスト対象外

以下の項目は、MVPリリース時点ではテスト対象外とします。

- OSレベルのプッシュ通知到達保証
- 完全オフラインでの継続利用
- App Store / Google Play 審査要件

---

## 13. テストファイル対応表

| テストファイル | 対象ID | 内容 |
|---------------|--------|------|
| `src/__tests__/validations/auth.test.ts` | TC-AUTH-02〜04, TC-AUTH-09 | 認証バリデーション |
| `src/__tests__/validations/hedgehog.test.ts` | TC-HH-03〜06 | 個体バリデーション |
| `src/__tests__/validations/image-upload.test.ts` | TC-HH-08〜10 | 画像アップロードバリデーション |
| `src/__tests__/validations/records.test.ts` | TC-VR-07〜17 | 健康記録バリデーション |
| `src/__tests__/validations/hospital.test.ts` | TC-HV-01〜07 | 通院記録バリデーション |
| `src/__tests__/validations/calendar.test.ts` | TC-CAL-01〜03 | カレンダーバリデーション |
| `src/__tests__/validations/reminder.test.ts` | TC-REM-01〜03 | リマインダーバリデーション |
| `src/__tests__/actions/hedgehog.test.ts` | TC-HH-01 | 個体管理アクション |
| `src/__tests__/actions/records.test.ts` | TC-VR-01〜04, TC-VR-18〜20 | 健康記録アクション |

---

## 14. テスト実行方法

```bash
# 全テスト実行
npm run test:run

# カバレッジ付きテスト
npm run test:coverage

# 監視モードでテスト
npm run test

# E2Eテスト（Playwright）
npm run test:e2e
```

---

## 15. P1テストケースの詳細理由

本セクションでは、優先度P1（🟡）として設定したテストケースについて、なぜP1としたのか、その理由を説明します。

### TC-SYS-02: PWA更新

PWAはブラウザのキャッシュ機能により、旧バージョンのアプリが残り続ける可能性がある。新版をデプロイしても、ユーザーが旧バージョンを使い続けると、新機能が使えなかったり、バグが修正されない問題が発生する。

MVPリリース時点では、頻繁なバージョンアップデートは想定されておらず、Service Workerの更新メカニズムが完全に機能しなくても、ユーザーがブラウザを再起動することで最新版が適用される。V1.x以降で、Service Workerの更新メカニズムを適切に実装する。

### TC-ADM-01: エクスポート形式

管理者がデータ分析を行う際、CSV形式でのエクスポートが必要。文字コード（UTF-8 BOM）が正しく設定されていないと、Excel等で開いた際に日本語が文字化けする。また、複数のデータ種別をエクスポートする場合は、ZIP形式でまとめることで、ダウンロードと管理が容易になる。

MVPリリース時点では、管理者機能は限定的であり、データ分析はV1.x以降で本格的に実施する予定。そのため、エクスポート形式の完全な検証は、V1.x以降で実施する。

### TC-ADM-02: 権限ガード

管理画面には、全ユーザーの個人情報や健康記録が表示されるため、一般ユーザーがアクセスできると重大なプライバシー侵害が発生する。URLを直接入力してアクセスを試みる攻撃（直接URLアクセス）に対して、BE側とDB側（RLS）の両方で権限チェックを行い、未承認アクセスを完全に遮断する必要がある。

MVPリリース時点では、管理者機能へのアクセスは限定的であり、基本的な認証・認可機能（TC-AUTH-06, TC-AUTH-07）が動作していれば、重大なセキュリティリスクは発生しない。V1.x以降で、管理者機能の本格運用に備え、権限ガードの完全な検証を実施する。

---

## 16. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| v1.0 | 2025-12-18 | 初版作成 |
| v2.0 | 2026-01-19 | 自動テスト対応版に改版。テストケースを大幅拡充（41件→50件以上）。テスト種別とファイル対応表を追加。 |