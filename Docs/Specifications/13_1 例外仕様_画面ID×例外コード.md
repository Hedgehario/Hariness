**プロジェクト名**: Hariness（ハリネス）  
**作成日**: 2025年12月18日  
**更新日**: 2025年12月18日  
**作成者**: 城田 航  
**関連文書**: `13_例外仕様書.md`

---

## 1. 概要

本ドキュメントは、`13_例外仕様書.md` で定義された例外コードが各画面で発生した際の、**画面遷移・UI挙動**を画面IDごとに整理したマトリクス表です。

画面ID（A01, H10, R12 など）と例外コード（E001, E002 など）の組み合わせごとに、具体的な遷移先やUI表示方法を定義することで、実装時の一貫性とトレーサビリティを確保します。

## 2. 目的

本ドキュメントの目的は以下の通りです：

1. **実装時の判断基準の明確化**: 各画面で例外が発生した際の処理を事前に定義し、実装時の if/else 分岐の迷いをなくします。
2. **画面定義書・例外仕様書とのトレーサビリティ確保**: 画面ID（`07_画面構成リスト.md`）と例外コード（`13_例外仕様書.md`）を明確に紐付けることで、仕様変更時の影響範囲を把握しやすくします。
3. **一貫したUXの実現**: 同じ例外コードでも画面文脈に応じた適切な挙動を定義し、ユーザー体験の一貫性を保ちます。

---

## 3. 画面ID × 例外コード × 遷移先 対応表

### 3.1 認証・初期導線系（A）

| 画面ID  | 画面名                         | 例外コード                  | 遷移 / UI挙動                                                                                      |
| :------ | :----------------------------- | :-------------------------- | :------------------------------------------------------------------------------------------------- |
| **A01** | ログイン                       | `E002` AUTH_FAILED          | 画面遷移なし。フォーム下にエラーメッセージ表示。                                                   |
| **A01** | ログイン                       | `E901` NETWORK_ERROR        | トースト表示（赤）。再試行を促す。                                                                 |
| **A01** | ログイン                       | `E999` INTERNAL_SERVER      | トースト表示（赤）。                                                                               |
| **A02** | 新規登録                       | `E006` CONFLICT             | フォーム下に「メールアドレス重複」メッセージ表示。                                                 |
| **A02** | 新規登録                       | `E001` VALIDATION           | 対象項目を赤枠表示し、理由を併記。                                                                 |
| **A05** | パスワードリセット（送信）     | `E001` VALIDATION           | 対象項目を赤枠表示。                                                                               |
| **A05** | パスワードリセット（送信）     | `E005` NOT_FOUND            | フォーム下に「メールアドレスが見つかりません」メッセージ表示（セキュリティ上、曖昧な表現でも可）。 |
| **A05** | パスワードリセット（送信）     | `E901` NETWORK_ERROR        | トースト表示（赤）。再試行を促す。                                                                 |
| **A07** | パスワードリセット（更新）     | `E001` VALIDATION           | 対象項目を赤枠表示（パスワードポリシー違反など）。                                                 |
| **A07** | パスワードリセット（更新）     | `E003` AUTH_REQUIRED        | `/login` へリダイレクト（トークン期限切れ等）。                                                    |
| **A07** | パスワードリセット（更新）     | `E901` NETWORK_ERROR        | トースト表示（赤）。**入力内容は保持する。**                                                       |
| **A09** | 飼い主プロフィール登録（初回） | `E001` VALIDATION           | 対象項目を赤枠表示。                                                                               |
| **A09** | 飼い主プロフィール登録（初回） | `E901` NETWORK_ERROR        | トースト表示（赤）。**入力内容は保持する。**                                                       |
| **A10** | 個体編集/新規登録（初回）      | `E001` VALIDATION           | 対象項目を赤枠表示。                                                                               |
| **A10** | 個体編集/新規登録（初回）      | `E007` LIMIT_EXCEEDED       | モーダル表示（上限により登録不可の説明）。                                                         |
| **A10** | 個体編集/新規登録（初回）      | `E008-1` STORAGE_VALIDATION | 画像アップロード前のエラー。フォーム下にメッセージ表示。                                           |
| **A10** | 個体編集/新規登録（初回）      | `E008-2` STORAGE_UPLOAD     | 画像アップロード失敗。トースト表示（赤）。                                                         |
| **A10** | 個体編集/新規登録（初回）      | `E901` NETWORK_ERROR        | トースト表示（赤）。**入力内容は保持する。**                                                       |

### 3.2 ホーム系（H）

| 画面ID  | 画面名                | 例外コード                       | 遷移 / UI挙動                                            |
| :------ | :-------------------- | :------------------------------- | :------------------------------------------------------- |
| **H10** | ホーム（個体ベース）  | `E003` AUTH_REQUIRED             | `/login` へリダイレクト。                                |
| **H10** | ホーム（個体ベース）  | `E005` NOT_FOUND（個体）         | ホーム再表示（リロード相当）＋個体選択を最新状態に更新。 |
| **H11** | リマインダー一覧      | `E003` AUTH_REQUIRED             | `/login` へリダイレクト。                                |
| **H11** | リマインダー一覧      | `E005` NOT_FOUND（リマインダー） | 一覧を更新（削除済行を消去）＋トースト表示。             |
| **H11** | リマインダー一覧      | `E901` NETWORK_ERROR             | トースト表示（赤）。再試行を促す。                       |
| **H12** | リマインダー登録/編集 | `E001` VALIDATION                | 対象項目を赤枠表示。                                     |
| **H12** | リマインダー登録/編集 | `E005` NOT_FOUND（リマインダー） | リマインダー一覧へ遷移＋トースト表示。                   |
| **H12** | リマインダー登録/編集 | `E901` NETWORK_ERROR             | トースト表示（赤）。**入力内容は保持する。**             |

### 3.3 個体登録系（P）

| 画面ID  | 画面名            | 例外コード                  | 遷移 / UI挙動                                            |
| :------ | :---------------- | :-------------------------- | :------------------------------------------------------- |
| **P10** | 個体編集/新規登録 | `E001` VALIDATION           | 対象項目を赤枠表示。                                     |
| **P10** | 個体編集/新規登録 | `E005` NOT_FOUND（個体）    | ホームへ遷移＋トースト表示。                             |
| **P10** | 個体編集/新規登録 | `E007` LIMIT_EXCEEDED       | モーダル表示（上限により登録不可の説明）。               |
| **P10** | 個体編集/新規登録 | `E008-1` STORAGE_VALIDATION | 画像アップロード前のエラー。フォーム下にメッセージ表示。 |
| **P10** | 個体編集/新規登録 | `E008-2` STORAGE_UPLOAD     | 画像アップロード失敗。トースト表示（赤）。               |
| **P10** | 個体編集/新規登録 | `E901` NETWORK_ERROR        | トースト表示（赤）。**入力内容は保持する。**             |

### 3.4 健康記録系（R）

| 画面ID  | 画面名                     | 例外コード                 | 遷移 / UI挙動                                                        |
| :------ | :------------------------- | :------------------------- | :------------------------------------------------------------------- |
| **R10** | 記録履歴トップ             | `E003` AUTH_REQUIRED       | `/login` へリダイレクト。                                            |
| **R10** | 記録履歴トップ             | `E005` NOT_FOUND（記録）   | 一覧画面を更新（削除済行を消去）＋トースト表示。                     |
| **R10** | 記録履歴トップ             | `E901` NETWORK_ERROR       | トースト表示（赤）。再試行を促す。                                   |
| **R11** | 今日の記録確認画面         | `E005` NOT_FOUND（記録）   | 記録履歴トップへ遷移＋トースト表示。                                 |
| **R11** | 今日の記録確認画面         | `E901` NETWORK_ERROR       | トースト表示（赤）。再試行を促す。                                   |
| **R12** | 今日の記録（記録フォーム） | `E001` VALIDATION          | 入力項目を赤枠表示。                                                 |
| **R12** | 今日の記録（記録フォーム） | `E006` CONFLICT            | 同日重複メッセージをトースト表示（体重・環境記録など）。             |
| **R12** | 今日の記録（記録フォーム） | `E901` NETWORK_ERROR       | トースト表示（赤）。**入力内容は保持する。**                         |
| **R12** | 今日の記録（記録フォーム） | `E999` INTERNAL_SERVER     | トースト表示（赤）。**入力内容は保持する。**                         |
| **R13** | 記録履歴（グラフ表示）     | `E003` AUTH_REQUIRED       | `/login` へリダイレクト。                                            |
| **R13** | 記録履歴（グラフ表示）     | `E005` NOT_FOUND（データ） | グラフを非表示＋トースト表示（「表示できるデータがありません」等）。 |
| **R13** | 記録履歴（グラフ表示）     | `E901` NETWORK_ERROR       | トースト表示（赤）。再試行を促す。                                   |

### 3.5 通院・治療記録系（V）

| 画面ID  | 画面名                   | 例外コード               | 遷移 / UI挙動                                |
| :------ | :----------------------- | :----------------------- | :------------------------------------------- |
| **V10** | 通院記録（記録フォーム） | `E001` VALIDATION        | 対象項目を赤枠表示。                         |
| **V10** | 通院記録（記録フォーム） | `E005` NOT_FOUND（個体） | ホームへ遷移＋トースト表示。                 |
| **V10** | 通院記録（記録フォーム） | `E901` NETWORK_ERROR     | トースト表示（赤）。**入力内容は保持する。** |
| **V10** | 通院記録（記録フォーム） | `E999` INTERNAL_SERVER   | トースト表示（赤）。**入力内容は保持する。** |
| **V11** | 通院記録（確認画面）     | `E005` NOT_FOUND（記録） | 通院記録フォームへ戻る＋トースト表示。       |
| **V11** | 通院記録（確認画面）     | `E901` NETWORK_ERROR     | トースト表示（赤）。再試行を促す。           |

### 3.6 設定系（S）

| 画面ID  | 画面名                 | 例外コード             | 遷移 / UI挙動                                            |
| :------ | :--------------------- | :--------------------- | :------------------------------------------------------- |
| **S10** | 飼い主プロフィール登録 | `E001` VALIDATION      | 対象項目を赤枠表示。                                     |
| **S10** | 飼い主プロフィール登録 | `E003` AUTH_REQUIRED   | `/login` へリダイレクト。                                |
| **S10** | 飼い主プロフィール登録 | `E901` NETWORK_ERROR   | トースト表示（赤）。**入力内容は保持する。**             |
| **S13** | 退会                   | `E003` AUTH_REQUIRED   | `/login` へリダイレクト。                                |
| **S13** | 退会                   | `E004` FORBIDDEN       | 権限エラーモーダル表示（通常は発生しないが、念のため）。 |
| **S13** | 退会                   | `E901` NETWORK_ERROR   | トースト表示（赤）。再試行を促す。                       |
| **S13** | 退会                   | `E999` INTERNAL_SERVER | トースト表示（赤）。退会処理は慎重に扱う。               |

### 3.7 カレンダー系（C）

| 画面ID  | 画面名            | 例外コード                   | 遷移 / UI挙動                                |
| :------ | :---------------- | :--------------------------- | :------------------------------------------- |
| **C10** | カレンダートップ  | `E003` AUTH_REQUIRED         | `/login` へリダイレクト。                    |
| **C10** | カレンダートップ  | `E005` NOT_FOUND（個体）     | ホーム再表示＋個体選択を最新状態に更新。     |
| **C10** | カレンダートップ  | `E901` NETWORK_ERROR         | トースト表示（赤）。再試行を促す。           |
| **C11** | イベント追加/編集 | `E001` VALIDATION            | 対象項目を赤枠表示。                         |
| **C11** | イベント追加/編集 | `E005` NOT_FOUND（イベント） | カレンダートップへ遷移＋トースト表示。       |
| **C11** | イベント追加/編集 | `E901` NETWORK_ERROR         | トースト表示（赤）。**入力内容は保持する。** |

### 3.8 通知系（I）

| 画面ID  | 画面名   | 例外コード               | 遷移 / UI挙動                                |
| :------ | :------- | :----------------------- | :------------------------------------------- |
| **I10** | 通知一覧 | `E003` AUTH_REQUIRED     | `/login` へリダイレクト。                    |
| **I10** | 通知一覧 | `E005` NOT_FOUND（通知） | 一覧を更新（削除済行を消去）＋トースト表示。 |
| **I10** | 通知一覧 | `E901` NETWORK_ERROR     | トースト表示（赤）。再試行を促す。           |

### 3.9 マップ系（M）

| 画面ID  | 画面名                     | 例外コード           | 遷移 / UI挙動                                              |
| :------ | :------------------------- | :------------------- | :--------------------------------------------------------- |
| **M10** | マップトップ（病院マップ） | `E003` AUTH_REQUIRED | `/login` へリダイレクト。                                  |
| **M10** | マップトップ（病院マップ） | `E901` NETWORK_ERROR | トースト表示（赤）。Googleマップ埋め込みの読み込み失敗時。 |

### 3.10 管理者系（ADM）

| 画面ID    | 画面名             | 例外コード                     | 遷移 / UI挙動                                |
| :-------- | :----------------- | :----------------------------- | :------------------------------------------- |
| **ADM00** | 管理ダッシュボード | `E003` AUTH_REQUIRED           | `/login` へリダイレクト。                    |
| **ADM00** | 管理ダッシュボード | `E004` FORBIDDEN               | ホームへ遷移＋権限エラーモーダル表示。       |
| **ADM00** | 管理ダッシュボード | `E901` NETWORK_ERROR           | トースト表示（赤）。再試行を促す。           |
| **ADM10** | データエクスポート | `E003` AUTH_REQUIRED           | `/login` へリダイレクト。                    |
| **ADM10** | データエクスポート | `E004` FORBIDDEN               | 操作ブロック、または権限エラーモーダル表示。 |
| **ADM10** | データエクスポート | `E005` NOT_FOUND（データなし） | トースト表示（「対象データがありません」）。 |
| **ADM10** | データエクスポート | `E901` NETWORK_ERROR           | 処理中断＋再試行を促すトースト表示。         |
| **ADM10** | データエクスポート | `E999` INTERNAL_SERVER         | **画面上部に赤色のエラーバナーを表示。**     |
| **ADM20** | お知らせ管理       | `E003` AUTH_REQUIRED           | `/login` へリダイレクト。                    |
| **ADM20** | お知らせ管理       | `E004` FORBIDDEN               | ホームへ遷移＋権限エラーモーダル表示。       |
| **ADM20** | お知らせ管理       | `E005` NOT_FOUND（お知らせ）   | 一覧を更新（削除済行を消去）＋トースト表示。 |
| **ADM20** | お知らせ管理       | `E901` NETWORK_ERROR           | トースト表示（赤）。再試行を促す。           |
| **ADM20** | お知らせ管理       | `E999` INTERNAL_SERVER         | トースト表示（赤）。**入力内容は保持する。** |

---

## 4. 補足: 共通ルール

1.  **E003 (未認証)** は原則として全画面で `/login` へのリダイレクトとして扱います。
2.  **E005 (NOT_FOUND)** は、画面文脈（一覧か詳細か）によって「一覧更新」か「ホーム/404遷移」かを判断します。
3.  **Error レベル**（E9xx系）発生時は、ユーザーの入力データを極力**保持**し、再送可能な状態を維持することを原則とします。

---

## 5. 関連文書

- `13_例外仕様書.md`: 例外コードの詳細定義
- `07_画面構成リスト.md`: 画面IDと画面名の対応
- `12_API仕様書.md`: Server Actions のエラー返却形式
